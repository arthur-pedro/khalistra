generator client {
  provider = "prisma-client-js"
  binaryTargets = "linux-musl-openssl-3.0.x"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Player {
  id             String   @id
  alias          String   @unique
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  matchesAsLight Match[]  @relation("MatchLight")
  matchesAsShadow Match[] @relation("MatchShadow")
  roomsAsHost    Room[]   @relation("RoomHost")
  roomsAsGuest   Room[]   @relation("RoomGuest")

  @@map("players")
}

model Match {
  id             String   @id
  lightPlayerId  String
  shadowPlayerId String
  status         String   @default("awaiting")
  activePlayerId String
  turn           Int      @default(1)
  winnerId       String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  lightPlayer  Player @relation("MatchLight", fields: [lightPlayerId], references: [id])
  shadowPlayer Player @relation("MatchShadow", fields: [shadowPlayerId], references: [id])
  moves        MoveRecord[]
  snapshots    MatchSnapshot[]
  room         Room?    @relation("RoomMatch")

  @@index([lightPlayerId])
  @@index([shadowPlayerId])
  @@index([status])

  @@map("matches")
}

model MoveRecord {
  id        Int      @id @default(autoincrement())
  matchId   String
  actorId   String
  pieceId   String
  turn      Int
  payload   Json
  createdAt DateTime @default(now())

  match Match @relation(fields: [matchId], references: [id])

  @@index([matchId])
  @@index([matchId, turn])

  @@map("move_records")
}

model MatchSnapshot {
  id        Int          @id @default(autoincrement())
  matchId   String
  turn      Int
  kind      SnapshotKind @default(RUNTIME)
  state     Json
  createdAt DateTime      @default(now())

  match Match @relation(fields: [matchId], references: [id])

  @@index([matchId])
  @@index([matchId, turn])

  @@map("match_snapshots")
}

enum SnapshotKind {
  INIT
  RUNTIME
}

enum RoomStatus {
  WAITING
  READY
  IN_MATCH
  CLOSED
  EXPIRED
}

model Room {
  id               String     @id @default(uuid())
  code             String     @unique
  status           RoomStatus @default(WAITING)
  matchId          String?
  hostPlayerId     String
  guestPlayerId    String?
  hostDisplayName  String
  guestDisplayName String?
  hostSecret       String
  guestSecret      String?
  hostJoinedAt     DateTime  @default(now())
  guestJoinedAt    DateTime?
  createdAt        DateTime   @default(now())
  updatedAt        DateTime   @updatedAt
  expiresAt        DateTime

  match       Match?  @relation("RoomMatch", fields: [matchId], references: [id])
  hostPlayer  Player  @relation("RoomHost", fields: [hostPlayerId], references: [id])
  guestPlayer Player? @relation("RoomGuest", fields: [guestPlayerId], references: [id])

  @@unique([matchId])
  @@index([status])
  @@map("rooms")
}
